<script>
  let currentPage = 0;
  let drafts = {};
  let emailStatus = { replied: {}, dismissed: {} };
  let isLoading = false;


  function loadEmails(page) {
    if (page < 0) return;

    google.script.run
      .withSuccessHandler(status => {
        emailStatus = status; // Load replied and ignored emails from the backend
        google.script.run
          .withSuccessHandler(emails => {
            if (emails.length === 0) {
              isLoading = false;
              return;
            }

            currentPage = page;
            appendEmails(emails);
          })
          .withFailureHandler(error => {
            console.error("Error loading emails:", error.message);
          })
          .getEmails(page);
      })
      .getEmailStatus(); // Fetch replied and ignored emails on load
  }

  function appendEmails(emails) {
    const table = document.getElementById('emailTable');

    emails.forEach((email, index) => {
      if (emailStatus.dismissed[email.id]) {
        return; // Skip dismissed emails
      }

      const editorId = `reply-editor-${email.id}`;
      const iframeId = `email-iframe-${index + currentPage * emails.length}`; // Unique ID across pages

      const row = document.createElement('tr');
      row.id = `email-row-${email.id}`;
      row.innerHTML = emailBodyTemplate(email, iframeId) + replyBoxTemplate(email, editorId);
      table.appendChild(row);
    });

    isLoading = false;

    // Ensure email body content is injected properly for newly added emails
    setTimeout(() => injectEmailBodies(emails, currentPage), 500);
  }

  function injectEmailBodies(emails, pageNumber = 0) {
    emails.forEach((email, index) => {
      const iframeId = `email-iframe-${index + pageNumber * emails.length}`; // Match with unique ID in appendEmails
      const iframe = document.getElementById(iframeId);
      if (!iframe) return;

      const sanitizedBody = DOMPurify.sanitize(email.body, { USE_PROFILES: { html: true } });

      // Use `srcdoc` if supported (safer method)
      if ('srcdoc' in iframe) {
        iframe.srcdoc = sanitizedBody;
      } else {
        // Fallback for browsers that do not support `srcdoc`
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(sanitizedBody);
        doc.close();
      }
    });
  }

  function displayEmails(emails) {
    const table = document.getElementById('emailTable');
    table.innerHTML = '';

    emails.forEach((email, index) => {
      if (emailStatus.dismissed[email.id]) {
        return; // Skip dismissed emails
      }

      const editorId = `reply-editor-${email.id}`;
      const iframeId = `email-iframe-${index}`; // Unique identifier for the first page

      const row = document.createElement('tr');
      row.id = `email-row-${email.id}`;
      row.innerHTML = emailBodyTemplate(email, iframeId) + replyBoxTemplate(email, editorId);
      table.appendChild(row);
    });

    // Ensure email body content is injected properly
    setTimeout(() => injectEmailBodies(emails, 0), 500);
  }

  function dismissEmail(emailId) {
    google.script.run
      .withSuccessHandler(() => {
        emailStatus.dismissed[emailId] = true; // Save locally
        collapseEmailRow(emailId, "❌ Ignored", "red");
      })
      .dismissEmail(emailId); // Save to backend
  }

  function sendReply(emailId, editorId) {
    const editor = document.getElementById(editorId);
    const replyHtml = editor.innerHTML;

    google.script.run
      .withSuccessHandler(() => {
        google.script.run.markAsReplied(emailId);
        emailStatus.replied[emailId] = true;
        collapseEmailRow(emailId, "✅ Replied", "green");
      })
      .sendReply(emailId, replyHtml);  
  }

  function collapseEmailRow(emailId, statusText, color) {
    const row = document.getElementById(`email-row-${emailId}`);
    if (!row) return;

    // Find the email header inside the row
    const emailHeader = row.querySelector(".email-header");
    if (!emailHeader) return;

    // Preserve the header, remove everything else
    row.innerHTML = `
      <td colspan="2">
        <div class="email-header">
          ${emailHeader.innerHTML} <span style="color: ${color}; font-weight: bold;">${statusText}</span>
        </div>
      </td>
    `;
  }

  function emailBodyTemplate(email, iframeId) {
    return `
      <td>
        <?!= include('email-body'); ?>
      </td>
    `
    .replace(/\${email.sender}/g, email.sender)
    .replace(/\${email.subject}/g, email.subject)
    .replace(/\${iframeId}/g, iframeId)
  }

  function replyBoxTemplate(email, editorId, textColorId, bgColorId, imageUploaderId) {
    return `
      <td class="reply-container">
        <?!= include('reply-box'); ?>
      </td>
    `
    .replace(/\${editorId}/g, editorId)
    .replace(/\${email.id}/g, email.id)
    .replace(/\${textColorId}/g, textColorId)
    .replace(/\${bgColorId}/g, bgColorId)
    .replace(/\${imageUploaderId}/g, imageUploaderId);
  }

  function convertImageToBase64(event, editorId) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      const fileName = file.name;
      
      google.script.run
        .withSuccessHandler(cid => {
          // Insert inline image using CID
          const imgTag = `<img src="cid:${cid}" style="max-width: 100%;">`;
          document.getElementById(editorId).innerHTML += imgTag;
        })
        .uploadInlineImage(fileName, e.target.result);
    };
    reader.readAsDataURL(file);
  }
  
  function filterEmails(filter) {
    const rows = document.querySelectorAll("#emailTable tr");

    rows.forEach(row => {
      const emailId = row.id.replace("email-row-", "");

      if (filter === "all") {
        row.style.display = "table-row";
      } else if (filter === "replied" && emailStatus.replied[emailId]) {
        row.style.display = "table-row";
      } else if (filter === "ignored" && emailStatus.dismissed[emailId]) {
        row.style.display = "table-row";
      } else if (filter === "inbox" && !emailStatus.replied[emailId] && !emailStatus.dismissed[emailId]) {
        row.style.display = "table-row";
      } else {
        row.style.display = "none";
      }
    });
  }

  function formatText(editorId, command, value = null) {
    document.execCommand(command, false, value);
  }

  window.onscroll = function () {
    if (isLoading) return;

    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 50) {
      isLoading = true;
      loadEmails(currentPage + 1);
    }
  };

  window.onload = () => {
    loadEmails(0);
  };
</script>
